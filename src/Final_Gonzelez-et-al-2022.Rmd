---
title: "Final Puerto Rican Youth (Grades 7-12) Substance Use Manuscript Code"
author: "Daniel K. Feinberg"
date: "June 24, 2022"
output:
  html_document:
    theme: bootstrap
    highlight: pygments
    toc: yes
    toc_float: yes
    code_folding: show
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)


# Remove all environmental objects and start fresh
rm(list = ls())


## Attaching packages 

# Reproducibility 
library(here)

# General data wrangling/manipulation
library(tidyverse)
library(janitor)

# Graphing, tables, plots 
library(DT)
library(broom)
library(stargazer)
library(apaTables)
library(hexbin)
library(plotly)
library(kableExtra)
library(modelsummary)

# Statistical inferences
library(effsize)
library(aod)

# Ordinal regression
library(ordinal)  #ordinal regression package
library(rcompanion) #pseudo R square 
library(MASS) #plyr method (for getting data that allows the test of proportional odds)
library(brant) #test of proportional odds
library(AER) #adding pvalues to brant test

# Fun ;P
library(beepr)
```


# 1. Importing and cleaning data for descriptives and ordinal regression
```{r data_prep_descriptives_ordinalRegres}

## Reading in original .csv file
pr_youth_substance_use <- read_csv(here("data", "ORIGINAL_PR data numeric.csv")) %>% 
  clean_names()

## Creating cleaned subset for grades 7 and up (secondary only) and selecting 
## only needed variables for analysis
ordinalRegres_substanceUse <- pr_youth_substance_use %>% 
  dplyr::filter(grado >= 7) %>% 
  dplyr::select(region, 
                distrito, 
                grado, 
                q20, 
                q21, 
                q22, 
                masculino, 
                femenino, 
                s1,
                s2, 
                s3, 
                s4, 
                s5, 
                s6, 
                s7, 
                s8, 
                s9, 
                s10, 
                s11, 
                s12, 
                s19)

# Recoding "99" to "NA"
ordinalRegres_substanceUse[ordinalRegres_substanceUse==99] <- NA

## Creating new 'genero' variable by recoding femenino=1 as genero=1 (female) and 
## masculino=1 as genero=0 (male) using some simple math

# recoding in order to separate genders
ordinalRegres_substanceUse$femenino[ordinalRegres_substanceUse$femenino == 1] <- 2
ordinalRegres_substanceUse$masculino[ordinalRegres_substanceUse$masculino == 1] <- 3
ordinalRegres_substanceUse$masculino[ordinalRegres_substanceUse$masculino == 0] <- 1
ordinalRegres_substanceUse$femenino[ordinalRegres_substanceUse$femenino == 0] <- 1

# adding new variable named 'genero'
ordinalRegres_substanceUse <- ordinalRegres_substanceUse %>% 
  mutate(genero = femenino * masculino)
  
# making female=1 and male=0, while recoding when either both 'masculino' and 
# 'femenino' or neither of them were indicated as 'NA' 
ordinalRegres_substanceUse$genero[ordinalRegres_substanceUse$genero == 1] <- NA
ordinalRegres_substanceUse$genero[ordinalRegres_substanceUse$genero == 2] <- 1
ordinalRegres_substanceUse$genero[ordinalRegres_substanceUse$genero == 3] <- 0
ordinalRegres_substanceUse$genero[ordinalRegres_substanceUse$genero == 6] <- NA

# Pairwise deletion of NA values (removing all rows containing 'NA' values, since 
# full data is needed for summation variables of ptsd_symptom_total and social_support_total)
ordinalRegres_substanceUse <- ordinalRegres_substanceUse %>% 
  drop_na()

# labeling 'genero' variable
ordinalRegres_substanceUse$genero <- factor(ordinalRegres_substanceUse$genero,
                                      labels = c("Male", "Female"))

# All looks good, so I am removing 'femenino' and 'masculino' from the dataframe
# and adding variables 'social_support_total' and 'ptsd_symptom_total'
ordinalRegres_substanceUse <- ordinalRegres_substanceUse %>% 
  mutate(ptsd_symptom_total = 
           s1 + s2 + s3 + s4 + s5 + s6 + s7 + s8 + s9 + s10 + s11 + s12) %>% 
  mutate(social_support_total = q20 + q21 + q22) %>% 
  dplyr::select(-femenino, -masculino)


## Recoding 's19' as three-tiered ordinal factor
ordinalRegres_substanceUse$s19[ordinalRegres_substanceUse$s19 == 2] <- 1
ordinalRegres_substanceUse$s19[ordinalRegres_substanceUse$s19 == 3] <- 2
ordinalRegres_substanceUse$s19[ordinalRegres_substanceUse$s19 == 4] <- 2

ordinalRegres_substanceUse$s19 <- ordered(ordinalRegres_substanceUse$s19,
                                      labels = c("No Substance Use",
                                                 "Low Substance Use",
                                                 "High Substance Use"))
```


## a) Below is a list of the variables that will be included in ordinal regression and some information about them:
```{r included_variables}
summary(ordinalRegres_substanceUse)
```


## b) Variable types
```{r variable_types}
str(ordinalRegres_substanceUse)
```


## c) Verifying that dependent variable (s19) is ordered correctly
```{r verify_dv_order}
# Verifying dependent variable order
unique(ordinalRegres_substanceUse$s19)
```
- yep, looks good.


## d) Verifying cell sizes 
### d1. By social_support_total
```{r}
# Verifying cell sizes for social support
xtabs(~s19 + social_support_total, data = ordinalRegres_substanceUse)
```

### d2. By ptsd_symptom_total 
```{r}
# Verifying cell sizes for ptsd
xtabs(~s19 + ptsd_symptom_total, data = ordinalRegres_substanceUse)
```

### d3. By gender
```{r}
# Verifying cell sizes for gender
xtabs(~s19 + genero, data = ordinalRegres_substanceUse)
```

### d4. By grade
```{r}
# Verifying cell sizes for grade
xtabs(~s19 + grado, data = ordinalRegres_substanceUse)
```


# 2. Descriptive statistics for all students G7-G12 at all substance use levels

## a) Table 1: Variable values by substance use category, gender
```{r tibble_substanceUse_gender}

tibble_substanceUse_gender <- ordinalRegres_substanceUse %>% 
  group_by(s19, genero) %>%
  summarize(mean_ptsd_symptoms = mean(ptsd_symptom_total),
            sd_ptsd_symptoms = sd(ptsd_symptom_total),
            mean_social_support = mean(social_support_total),
            sd_social_supp = sd(social_support_total),
            sample_size = n())
datatable(tibble_substanceUse_gender) #show in knitted document

# To save full page graph in figures folder
#ggsave(here("figures", "tibble_substanceUse_gender.pdf"))
```



## b) Table 2: Variable values by grade, gender
```{r tibble_grade_gender}

tibble_grade_gender <- ordinalRegres_substanceUse %>% 
  group_by(grado, genero) %>%
  summarize(mean_ptsd_symptoms = mean(ptsd_symptom_total),
            sd_ptsd_symptoms = sd(ptsd_symptom_total),
            mean_social_support = mean(social_support_total),
            sd_social_supp = sd(social_support_total),
            sample_size = n())
datatable(tibble_grade_gender) #show in knitted document

# To save full page graph in figures folder
#ggsave(here("figures", "tibble_grade_gender.pdf"))
```

## c) Table 3: Variable values by grade, gender, substance use category
```{r tibble_grade_substanceUse_gender}

tibble_grade_substanceUse_gender <- ordinalRegres_substanceUse %>% 
  group_by(grado, s19, genero) %>%
  summarize(mean_ptsd_symptoms = mean(ptsd_symptom_total),
            sd_ptsd_symptoms = sd(ptsd_symptom_total),
            mean_social_support = mean(social_support_total),
            sd_social_supp = sd(social_support_total),
            sample_size = n())
datatable(tibble_grade_substanceUse_gender) #show in knitted document

# To save full page graph in figures folder
#ggsave(here("figures", "tibble_grade_substanceUse_gender.pdf"))
```



# 3. Ordinal Multiple Linear Regression Model Analysis (all students; n=36K)
## a) Running the model
    
In this analysis, we will conduct an ordinal multiple linear regression on **s19 (self-reported substance use)** to see how it changes with respect to three predictor variables: **social support**, **ptsd_symptom_total**, **grade**, **gender**,. 

Here's our model: 

```{r ordinal_regression}
clm_with_interaction <- clm(as.factor(s19) ~  q20 + q21 + q22 +
                              ptsd_symptom_total + grado + genero + 
                              genero*ptsd_symptom_total + genero*q20 + 
                              genero*q21 + genero*q22, 
                            data = ordinalRegres_substanceUse, 
                            link = "logit")

#Null model
null_clm <- clm(as.factor(s19) ~ 1, 
                  data = ordinalRegres_substanceUse, 
                  link = "logit")
```


### a1. Coefficients: ordinal regression
```{r ordinal_regression_coefficients}
# Coefficients
summary(clm_with_interaction)
```

### a2. Confidence Intervals: ordinal regression
```{r ordinal_regression_CI}
# Confidence intervals
confint(clm_with_interaction)
```

### a3. Odds ratios: ordinal regression
```{r ordinal_regression_oddsRatiosCoefficients}
# Produce odds ratios 
exp(coef(clm_with_interaction))
```

### a4. Confidence Intervals: odds ratios
```{r ordinal_regression_oddsRatiosCI}
# Confidence intervals for odds ratios
exp(confint(clm_with_interaction))
```


## b) Evaluating model fit
### b1. Method 1: ANOVA
```{r ordinal_regression_anova_stats}
anova(null_clm, clm_with_interaction)
```

### b2. Method 2: Nagelkerke
```{r ordinal_regression_nagelkerke}
nagelkerke(fit = clm_with_interaction,
           null = null_clm)
```



### b3. Testing parallel lines/proportional odds

#### b3.1. Brant test 
```{r brant_test}
forBrant_clm_with_interaction <- polr(as.factor(s19) ~  q20 + q21 + q22 +
                              ptsd_symptom_total + grado + genero +
                                genero*ptsd_symptom_total + genero*q20 +
                                genero*q21 + genero*q22,
                              data = ordinalRegres_substanceUse,
                              Hess = TRUE)

brant(forBrant_clm_with_interaction)
```

#### b3.2. Summary: Brandt Test
```{r brant_summary}
summary(forBrant_clm_with_interaction)
```

#### b3.3. p-values: Brandt Test
```{r brandt_pValues}
# for adding p-values
coeftest(forBrant_clm_with_interaction)
```

 
## c) Tidy model results

### c1. Coefficients

To get information about the coefficients in a more manageable format (a data frame), use `broom::tidy()`:

```{r tidy_coefficients}
clm_tidy <- tidy(clm_with_interaction)

# Return it:
clm_tidy
```


### c2. Deeper Interpretation (NEEDS WORK)

- **No Substance Use Intercept:** This coefficient value (`r round(clm_tidy$estimate[1],3)`) is not meaningful to interpret here on its own (though should still be included when making predictions). Technically, it is the log odds of the expected substance use of a student with social support value of 0.  Often, the intercept is not useful to consider on its own (and reflects limits to how far we should extrapolate our model results beyond our observed data).

- **Low Substance Use Intercept:** This coefficient value (`r round(clm_tidy$estimate[2],3)`) is not meaningful to interpret here on its own (though should still be included when making predictions). Technically, it is the log odds of a student self-reporting low substance use with social support value of 0. Often, the intercept is not useful to consider on its own (and reflects limits to how far we should extrapolate our model results beyond our observed data).

- **social_support_adult:**  For those students that endorsed having **adult social support at home** the log odds of high substance use endorsement decreased significantly by `r round(clm_tidy$estimate[3],3)`.

- **social_support_peer:**  For those students that endorsed having **peer social support** the log odds of high substance use endorsement increased significantly by `r round(clm_tidy$estimate[4],3)`.

- **social_support_teacher/counselor:**  For those students that endorsed having **teacher or counselor social support at school** the log odds of high substance use endorsement decreased significantly by `r round(clm_tidy$estimate[5],3)`.

- **ptsd_symptom_total** For every one unit increase in **ptsd symptoms** the log odds of high substance use increased significantly by `r round(clm_tidy$estimate[6],3)`.

- **grado:** For each increase in **grade level** the log odds of high substance use increased significantly by `r round(clm_tidy$estimate[7],3)`.  did not appear significant

- **gender:** This coefficient is also for a categorical variable (where male is the reference level). We interpret the coefficient for *gender* (`r round(clm_tidy$estimate[8],3)`) as follows: if all variables are held constant, we expect a *female* student to endorse substance use by a log odds of `r round(clm_tidy$estimate[7],3)` **less** than a male student, on average.

- **Interaction: gender & ptsd:** This coefficient describes the interaction between **gender** and **ptsd** symptoms. With all variables  held constant, we expect that students who identify as *female* and who experience ptsd symptoms to endorse substance use by a log odds of `r round(clm_tidy$estimate[8],3)` **less** than students who identify as male and experience ptsd symptoms.


### c3. Overall model fit and significance

You can see and parse information for the overall model using `broom::glance()`:

```{r clm_fit_stats}
clm_fit_stats <- glance(clm_with_interaction)

# Return output:
clm_fit_stats
```


### c4. The `stargazer` package

Another option is the `stargazer` package, which creates a comprehensive regression table (including in html format). 

Use the `stargazer()` function on your model name to produce the table. **NOTE:** to get this to appear correctly in your knitted html, you need to include two things:

- In the **code chunk header** add an option `results = "asis"` (i.e., the entire code chunk header should look like this: `{r, results = "asis"}`)
- Include the argument `type = "html"` within the `stargazer()` function as below (since the default is LaTeX)

```{r stargazer, results = "asis"}
stargazer(clm_with_interaction, type = "html")
```


### c5. Looking at results as odds ratios with confidence intervals instead of log likelihood
```{r odds_ratios_again}
odds_ratio_clm <- exp(cbind(OR = coef(clm_with_interaction),
                                                confint(clm_with_interaction)))

odds_ratio_clm
```


### c6. Figure 1: Likelihood vs. Odds
```{r likelihood_vs_odds_fig, echo=FALSE, out.width="50%", fig.cap="Probabilities vs. Odds"}
knitr::include_graphics(here("img", "prob_vs_odds.png"))
```


### c7. (SECTION BELOW NEEDS WORK)
```{r tidy_odds_ratio, echo=FALSE}
# creating tidy references for section below
tidy_odds_ratio_clm <- tidy(odds_ratio_clm)
```


- Now we see that for those with increasing **social support endorsements**, the odds of endorsing high substance use (versus low substance use) decreases by a factor of approximately `r round(tidy_odds_ratio_clm$x[,"OR"][2],2)`, `r round(tidy_odds_ratio_clm$x[,"OR"][3],2)`, and `r round(tidy_odds_ratio_clm$x[,"OR"][4],2)` respectively. 

- We can also see that with increasing **PTSD Symptom Total**, the odds of endorsing high substance use (versus low substance use) increases by a factor of approximately `r round(tidy_odds_ratio_clm$x[,"OR"][5],2)`,

- **Grade** was not indicated is significant and therefore should not be interpreted 

- Lastly, we see that if a student is **female**, the odds of endorsing high substance use (versus low substance use) decreases by a factor of approximately `r round(tidy_odds_ratio_clm$x[,"OR"][7],2)`.
 
For more information on interpreting odds ratios see: [How do I interpret odds ratios in logistic regression?](https://rpubs.com/raoulbia/interpreting_glm_logistic_regression_output). While R produces it, the odds ratio for the intercept is not generally interpreted. 


Likelihood ratio test (the deviance residual is -2*log likelihood). See the model’s log likelihood below:
```{r}
logLik(clm_with_interaction)
```




